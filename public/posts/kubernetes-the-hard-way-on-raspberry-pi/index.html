<!DOCTYPE html>
<html
  dir="ltr"
  lang="ja"
  data-theme=""
><head>
  <title>
    
      sosomasox
        |
        Kubernetes The Hard Way on Raspberry Piをやった話


      


    
  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.92.2" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      


    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="/css/main.min.24f9f28bfaca2cdc5a222bb5e42d30c701d7ffb0b31d30dfc4afc0e044dfbf24.css"
    integrity="sha256-JPnyi/rKLNxaIiu15C0wxwHX/7CzHTDfxK/A4ETfvyQ="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.058b31f17db60602cc415fd63b0427e7932fbf35c70d8e341a4c39385f5f6f3e.css"
    integrity="sha256-BYsx8X22BgLMQV/WOwQn55MvvzXHDY40Gkw5OF9fbz4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="https://sosomasox.com/posts/kubernetes-the-hard-way-on-raspberry-pi/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js"
    integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js"
      integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus="
      crossorigin="anonymous"
    ></script>

  

  


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes The Hard Way on Raspberry Piをやった話"/>
<meta name="twitter:description" content="先日、Raspberry Pi上でKubernetes The Hard Wayに挑戦しました。 本記事はそのときの手順をまとめたものです。 物理環境 Raspberry Pi 4 Model B 8GB"/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "Kubernetes The Hard Way on Raspberry Piをやった話",
        "headline": "Kubernetes The Hard Way on Raspberry Piをやった話",
        "alternativeHeadline": "",
        "description": "
      
        先日、Raspberry Pi上でKubernetes The Hard Wayに挑戦しました。 本記事はそのときの手順をまとめたものです。 物理環境 Raspberry Pi 4 Model B 8GB


      


    ",
        "inLanguage": "ja",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/sosomasox.com\/posts\/kubernetes-the-hard-way-on-raspberry-pi\/"
        },
        "author" : {
            "@type": "Person",
            "name": "sosomasox"
        },
        "creator" : {
            "@type": "Person",
            "name": "sosomasox"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "sosomasox"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "sosomasox"
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-03-30T13:56:00.00Z",
        "datePublished": "2021-03-30T13:56:00.00Z",
        "dateModified": "2021-03-30T13:56:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "sosomasox",
            "url": "https://sosomasox.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/sosomasox.com\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/sosomasox.com\/posts\/kubernetes-the-hard-way-on-raspberry-pi\/",
        "wordCount" : "10034",
        "genre" : [ ],
        "keywords" : [ ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/posts/"
              
              title=""
              >Posts</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/portfolio/"
              
              title=""
              >Portfolio</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/contact/"
              
              title=""
              >Contact</a
            >
          </li>

        
      </div>
      <ul>
        
        
          <li>
            <a class="theme-switch" title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </li>

        
      </ul>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="/images/profile.jpg" alt="profile picture" />
        <h3 title=""><a href="/">sosomasox</a></h3>
        <div class="description">
          <p></p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
        <li>
          <a href="https://github.com/sosomasox" rel="me" aria-label="GitHub" title="GitHub">
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://twitter.com/sosomasox" rel="me" aria-label="Twitter" title="Twitter">
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="mailto:t-soma@sosomasox.com" rel="me" aria-label="e-mail" title="e-mail">
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          sosomasox
          2022


        
      </li>
      
        <li class="footer__item">
          <a
            href="/imprint/"
            
            title=""
          >
            imprint
          </a>
        </li>

      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR&#43;zwDAROtph0PXGte6ia8heboACF9R5l/DiY&#43;WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous" /><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8&#43;w2LAIftJEULZABrF9PPFv&#43;tVkH" crossorigin="anonymous"></script><script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js"
      integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB&#43;w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v"
      crossorigin="anonymous"
      onload="renderMathInElement(document.body);"
    ></script></div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <meta name="twitter:title" content="Kubernetes The Hard Way on Raspberry Piをやった話" />
  <meta name="twitter:description" content="先日、Raspberry Pi上でKubernetes The Hard Wayに挑戦しました。 本記事はそのときの手順をまとめたものです。 物理環境 Raspberry Pi 4 Model B 8GB">
  <meta name="twitter:image" content="https://sosomasox.com/images/kubernetes-the-hard-way-on-raspberry-pi/thumbnail.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@sosomasox" />
  <meta name="twitter:creator" content="@sosomasox" />
  <meta property="og:title" content="Kubernetes The Hard Way on Raspberry Piをやった話" />
  <meta property="og:description" content="先日、Raspberry Pi上でKubernetes The Hard Wayに挑戦しました。 本記事はそのときの手順をまとめたものです。 物理環境 Raspberry Pi 4 Model B 8GB">
  <meta property="og:image" content="https://sosomasox.com/images/kubernetes-the-hard-way-on-raspberry-pi/thumbnail.jpg" />
  <meta property="og:url" content="https://sosomasox.com/posts/kubernetes-the-hard-way-on-raspberry-pi/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="sosomasox" />

  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
        <img class="post-thumbnail" src="/images/kubernetes-the-hard-way-on-raspberry-pi/thumbnail.jpg" alt="Thumbnail image" />

      
      <div class="post-title">
        <h1>Kubernetes The Hard Way on Raspberry Piをやった話</h1>
        
      </div><p> </p>
<p>先日、Raspberry Pi上でKubernetes The Hard Wayに挑戦しました。</p>
<p>本記事はそのときの手順をまとめたものです。</p>
<p> </p>
<p><img src="/images/kubernetes-the-hard-way-on-raspberry-pi/thumbnail.jpg" alt="Thumbnail"></p>
<p> </p>
<h3 id="物理環境">物理環境</h3>
<ul>
<li><a href="https://jp.rs-online.com/web/p/raspberry-pi/1822098/">Raspberry Pi 4 Model B 8GB</a> x8</li>
<li><a href="https://www.digikey.jp/product-detail/ja/raspberry-pi/POE-BOARD/1690-1026-ND/8641689">Raspberry Pi PoE HAT</a> x8</li>
<li><a href="https://www.tp-link.com/jp/business-networking/unmanaged-switch/tl-sg1210p/">TP-Link TL-SG1210P</a> x1</li>
<li><a href="https://www.c4labs.com/product/8-slot-stackable-cluster-case-raspberry-pi-3b-and-other-single-board-computers-color-options/">8 Slot Cloudlet Cluster Case - C4Labs</a> x1</li>
</ul>
<p> </p>
<h3 id="論理環境">論理環境</h3>
<ul>
<li>
<p>Kubernetes マスターノード x3</p>
<ul>
<li>Ubuntu 20.04.2</li>
<li>kube-apiserver v1.20.4</li>
<li>kube-controller-manager v1.20.4</li>
<li>kube-scheduler v1.20.4</li>
<li>kubectl v1.20.4</li>
<li>kubelet v1.20.4</li>
<li>kube-proxy v1.20.4</li>
<li>etcd v3.4.14</li>
<li>etcdctl v3.4.14</li>
<li>cni-plugins v0.9.1</li>
<li>crictl v1.20.0</li>
<li>containerd v1.3.3</li>
<li>runc v1.0.0</li>
<li>flanneld v0.13.0</li>
</ul>
</li>
<li>
<p>Kubernetes ワーカーノード x5</p>
<ul>
<li>Ubuntu 20.04.2</li>
<li>kubelet v1.20.4</li>
<li>kube-proxy v1.20.4</li>
<li>cni-plugins v0.9.1</li>
<li>crictl v1.20.0</li>
<li>containerd v1.3.3</li>
<li>runc v1.0.0</li>
<li>flanneld v0.13.0</li>
</ul>
</li>
<li>
<p>kube-apiserver用ロードバランサー x3 (Kubernetes マスターノード上で稼働)</p>
<ul>
<li>Keepalived v2.0.19</li>
<li>HAproxy v2.0.13</li>
</ul>
</li>
</ul>
<p><strong>なお、本環境ではマスターノードでもワーカーノードとして動作できるように設定します。</strong></p>
<p> </p>
<h3 id="ネットワーク環境">ネットワーク環境</h3>
<ul>
<li>
<p>Node用サブネット: 172.29.156.0/24</p>
<ul>
<li>kube-apiserver用ロードバランサー: 172.29.156.10</li>
<li>k8s-master1: 172.29.156.11</li>
<li>k8s-master2: 172.29.156.12</li>
<li>k8s-master3: 172.29.156.13</li>
<li>k8s-worker1: 172.29.156.14</li>
<li>k8s-worker2: 172.29.156.15</li>
<li>k8s-worker3: 172.29.156.16</li>
<li>k8s-worker4: 172.29.156.17</li>
<li>k8s-worker5: 172.29.156.18</li>
</ul>
</li>
<li>
<p>Pod用サブネット: 10.244.0.0/16 (Pod Networkとしてflannelを使用)</p>
</li>
<li>
<p>ClusterIP用サブネット: 10.96.0.0/12</p>
</li>
</ul>
<p> </p>
<h3 id="その他環境">その他環境</h3>
<ul>
<li>ubuntuユーザを使用</li>
</ul>
<p> </p>
<h3 id="ローカル環境上での作業">ローカル環境上での作業</h3>
<h3 id="ルート認証局の作成用設定ファイルの作成">ルート認証局の作成用設定ファイルの作成</h3>
<p>ルート認証局の作成に必要な以下の3つの設定ファイルをconfigフォルダ配下にを用意します。</p>
<p>設定ファイルの内容はリンク先を参考にして下さい。</p>
<ul>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/etcd-ca-config.json">etcd-ca-config.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kubernetes-ca-config.json">kubernetes-ca-config.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kubernetes-front-proxy-ca-config.json">kubernetes-front-proxy-ca-config.json</a></li>
</ul>
<p> </p>
<h3 id="各種証明書生成用設定ファイルの作成">各種証明書生成用設定ファイルの作成</h3>
<p>各種証明書を生成するために、本環境では以下の設定ファイルをconfigフォルダ配下にを用意します。</p>
<p>設定ファイルの内容はリンク先を参考にして下さい。</p>
<ul>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/admin-csr.json">admin-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/admin-csr.json">etcd-ca-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/front-proxy-client-csr.json">front-proxy-client-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-master1-csr.json">k8s-master1-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-master2-csr.json">k8s-master2-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-master3-csr.json">k8s-master3-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-worker1-csr.json">k8s-worker1-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-worker2-csr.json">k8s-worker2-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-worker3-csr.json">k8s-worker3-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-worker4-csr.json">k8s-worker4-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/k8s-worker5-csr.json">k8s-worker5-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-apiserver-etcd-client-csr.json">kube-apiserver-etcd-client-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-apiserver-k8s-master1-csr.json">kube-apiserver-k8s-master1-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-apiserver-k8s-master2-csr.json">kube-apiserver-k8s-master2-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-apiserver-k8s-master3-csr.json">kube-apiserver-k8s-master3-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-apiserver-kubelet-client-csr.json">kube-apiserver-kubelet-client-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-controller-manager-csr.json">kube-controller-manager-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-flanneld-client-csr.json">kube-etcd-flanneld-client-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-healthcheck-client-csr.json">kube-etcd-healthcheck-client-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-k8s-master1-csr.json">kube-etcd-k8s-master1-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-k8s-master2-csr.json">kube-etcd-k8s-master2-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-k8s-master3-csr.json">kube-etcd-k8s-master3-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-peer-k8s-master1-csr.json">kube-etcd-peer-k8s-master1-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-peer-k8s-master2-csr.json">kube-etcd-peer-k8s-master2-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-etcd-peer-k8s-master3-csr.json">kube-etcd-peer-k8s-master3-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-proxy-csr.json">kube-proxy-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kube-scheduler-csr.json">kube-scheduler-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kubernetes-ca-csr.json">kubernetes-ca-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/kubernetes-front-proxy-ca-csr.json">kubernetes-front-proxy-ca-csr.json</a></li>
<li><a href="https://github.com/sosomasox/kubernetes-the-hard-way-on-raspberry-pi/blob/main/config/service-account-csr.json">service-account-csr.json</a></li>
</ul>
<p> </p>
<h3 id="各種証明書の生成">各種証明書の生成</h3>
<p>Kubernetesを構成する各コンポーネント間の接続に必要な証明書の作成を行います。</p>
<p>まず、証明書の生成に使用するツールをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install -y golang-cfssl kubectl
</code></pre></div><p> </p>
<p>次に、下記のスクリプトを実行し、証明書の生成を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:gen-cert.sh" data-lang=":gen-cert.sh"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
MASTER1_HOSTNAME<span style="color:#f92672">=</span>k8s-master1
MASTER2_HOSTNAME<span style="color:#f92672">=</span>k8s-master2
MASTER3_HOSTNAME<span style="color:#f92672">=</span>k8s-master3
WORKER1_HOSTNAME<span style="color:#f92672">=</span>k8s-worker1
WORKER2_HOSTNAME<span style="color:#f92672">=</span>k8s-worker2
WORKER3_HOSTNAME<span style="color:#f92672">=</span>k8s-worker3
WORKER4_HOSTNAME<span style="color:#f92672">=</span>k8s-worker4
WORKER5_HOSTNAME<span style="color:#f92672">=</span>k8s-worker5
MASTER1_ADDRESS<span style="color:#f92672">=</span>172.29.156.11
MASTER2_ADDRESS<span style="color:#f92672">=</span>172.29.156.12
MASTER3_ADDRESS<span style="color:#f92672">=</span>172.29.156.13
WORKER1_ADDRESS<span style="color:#f92672">=</span>172.29.156.14
WORKER2_ADDRESS<span style="color:#f92672">=</span>172.29.156.15
WORKER3_ADDRESS<span style="color:#f92672">=</span>172.29.156.16
WORKER4_ADDRESS<span style="color:#f92672">=</span>172.29.156.17
WORKER5_ADDRESS<span style="color:#f92672">=</span>172.29.156.18
LOADBALANCER_ADDRESS<span style="color:#f92672">=</span>172.29.156.10
KUBERNETES_SVC_ADDRESS<span style="color:#f92672">=</span>10.96.0.1
KUBERNETES_HOSTNAMES<span style="color:#f92672">=</span>kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local


mkdir cert <span style="color:#f92672">&amp;&amp;</span> cd cert
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  exit
<span style="color:#66d9ef">fi</span>


echo <span style="color:#e6db74">&#34;---&gt; Generate etcd ca certificate&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -initca ../config/etcd-ca-csr.json | cfssljson -bare etcd-ca


echo <span style="color:#e6db74">&#34;---&gt; Generate kubernetes ca certificate&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -initca ../config/kubernetes-ca-csr.json | cfssljson -bare kubernetes-ca


echo <span style="color:#e6db74">&#34;---&gt; Generate kubernetes front proxy ca certificate&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -initca ../config/kubernetes-front-proxy-ca-csr.json | cfssljson -bare kubernetes-front-proxy-ca


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate kube-etcd&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-k8s-master1-csr.json | cfssljson -bare kube-etcd-k8s-master1

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-k8s-master2-csr.json | cfssljson -bare kube-etcd-k8s-master2

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-k8s-master3-csr.json | cfssljson -bare kube-etcd-k8s-master3


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate kube-etcd-peer&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-peer-k8s-master1-csr.json | cfssljson -bare kube-etcd-peer-k8s-master1

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-peer-k8s-master2-csr.json | cfssljson -bare kube-etcd-peer-k8s-master2

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-peer-k8s-master3-csr.json | cfssljson -bare kube-etcd-peer-k8s-master3


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate kube-etcd-healthcheck-client&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-healthcheck-client-csr.json | cfssljson -bare kube-etcd-healthcheck-client


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate kube-etcd-flanneld-client&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-etcd-flanneld-client-csr.json | cfssljson -bare kube-etcd-flanneld-client


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate kube-apiserver-etcd-client&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/etcd-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-apiserver-etcd-client-csr.json | cfssljson -bare kube-apiserver-etcd-client


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kubernetes admin user&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/admin-csr.json | cfssljson -bare admin


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kube-apiserver&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>LOADBALANCER_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_SVC_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_HOSTNAMES<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-apiserver-k8s-master1-csr.json | cfssljson -bare kube-apiserver-k8s-master1

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>LOADBALANCER_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_SVC_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_HOSTNAMES<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-apiserver-k8s-master2-csr.json | cfssljson -bare kube-apiserver-k8s-master2

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>LOADBALANCER_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_SVC_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>KUBERNETES_HOSTNAMES<span style="color:#e6db74">}</span><span style="color:#e6db74">,localhost,127.0.0.1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-apiserver-k8s-master3-csr.json | cfssljson -bare kube-apiserver-k8s-master3


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kube-apiserver-kubelet-client&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-apiserver-kubelet-client-csr.json | cfssljson -bare kube-apiserver-kubelet-client


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kube-controller-manager&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kube-scheduler&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/kube-scheduler-csr.json | cfssljson -bare kube-scheduler


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kubelet&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>MASTER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER1_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER2_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER3_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER4_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span>

cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>peer <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">${</span>WORKER5_ADDRESS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/<span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span>-csr.json | cfssljson -bare <span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span>


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for kube-proxy&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  ../config/kube-proxy-csr.json | cfssljson -bare kube-proxy


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for front-proxy-client&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-front-proxy-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-front-proxy-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-front-proxy-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>client <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/front-proxy-client-csr.json | cfssljson -bare front-proxy-client


echo <span style="color:#e6db74">&#34;---&gt; Generate certificate for generating token of ServiceAccount&#34;</span>
cfssl gencert <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca<span style="color:#f92672">=</span>kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -ca-key<span style="color:#f92672">=</span>kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -config<span style="color:#f92672">=</span>../config/kubernetes-ca-config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -profile<span style="color:#f92672">=</span>service-account <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ../config/service-account-csr.json | cfssljson -bare service-account


echo <span style="color:#e6db74">&#34;---&gt; Complete to generate certificate&#34;</span>

exit <span style="color:#ae81ff">0</span>
</code></pre></div><p> </p>
<h3 id="kubeconfigの生成">kubeconfigの生成</h3>
<p>下記のスクリプトを実行し、Kubernetesの各種コンポーネントがkube-apiserverと通信するための設定ファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:gen-kubeconfig.sh" data-lang=":gen-kubeconfig.sh"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
MASTER1_HOSTNAME<span style="color:#f92672">=</span>k8s-master1
MASTER2_HOSTNAME<span style="color:#f92672">=</span>k8s-master2
MASTER3_HOSTNAME<span style="color:#f92672">=</span>k8s-master3
WORKER1_HOSTNAME<span style="color:#f92672">=</span>k8s-worker1
WORKER2_HOSTNAME<span style="color:#f92672">=</span>k8s-worker2
WORKER3_HOSTNAME<span style="color:#f92672">=</span>k8s-worker3
WORKER4_HOSTNAME<span style="color:#f92672">=</span>k8s-worker4
WORKER5_HOSTNAME<span style="color:#f92672">=</span>k8s-worker5
MASTER_ADDRESS<span style="color:#f92672">=</span>172.29.156.10
MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">9000</span>
CERT_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../cert&#34;</span>


ls cert &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;Please run in the same directory as cert&#34;</span> 
  exit
<span style="color:#66d9ef">fi</span>

mkdir kubeconfig <span style="color:#f92672">&amp;&amp;</span> cd kubeconfig
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  exit
<span style="color:#66d9ef">fi</span>


echo <span style="color:#e6db74">&#34;---&gt; Generate kubelet kubeconfig&#34;</span>
<span style="color:#66d9ef">for</span> instance in <span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
  kubectl config set-cluster kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --certificate-authority<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --server<span style="color:#f92672">=</span>https://<span style="color:#e6db74">${</span>MASTER_ADDRESS<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>MASTER_PORT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.kubeconfig

  kubectl config set-credentials system:node:<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --client-certificate<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --client-key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.kubeconfig

  kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cluster<span style="color:#f92672">=</span>kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --user<span style="color:#f92672">=</span>system:node:<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.kubeconfig

  kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.kubeconfig
<span style="color:#66d9ef">done</span>


echo <span style="color:#e6db74">&#34;---&gt; Generate kube-proxy kubeconfig&#34;</span>
kubectl config set-cluster kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://<span style="color:#e6db74">${</span>MASTER_ADDRESS<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>MASTER_PORT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig

kubectl config set-credentials system:kube-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-certificate<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-proxy.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-proxy-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig

kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>system:kube-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig


echo <span style="color:#e6db74">&#34;---&gt; Generate kube-controller-manager kubeconfig&#34;</span>
kubectl config set-cluster kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://127.0.0.1:6443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-controller-manager.kubeconfig

kubectl config set-credentials system:kube-controller-manager <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-certificate<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-controller-manager.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-controller-manager-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-controller-manager.kubeconfig

kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>system:kube-controller-manager <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-controller-manager.kubeconfig

kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span>kube-controller-manager.kubeconfig


echo <span style="color:#e6db74">&#34;---&gt; Generate kube-scheduler kubeconfig&#34;</span>
kubectl config set-cluster kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://127.0.0.1:6443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-certificate<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-scheduler.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kube-scheduler-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-scheduler.kubeconfig

kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>system:kube-scheduler <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-scheduler.kubeconfig

kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span>kube-scheduler.kubeconfig


echo <span style="color:#e6db74">&#34;---&gt; Generate admin user kubeconfig&#34;</span>
kubectl config set-cluster kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://127.0.0.1:6443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>admin.kubeconfig

kubectl config set-credentials admin <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-certificate<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/admin.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CERT_DIR<span style="color:#e6db74">}</span>/admin-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>admin.kubeconfig

kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>admin.kubeconfig

kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span>admin.kubeconfig


echo <span style="color:#e6db74">&#34;---&gt; Complete to generate kubeconfig&#34;</span>

exit <span style="color:#ae81ff">0</span>
</code></pre></div><p> </p>
<h3 id="kube-apiserverがetcdに保存するデータを暗号化するための設定ファイルの作成">kube-apiserverがetcdに保存するデータを暗号化するための設定ファイルの作成</h3>
<p>下記のコマンドを実行し、kube-apiserverがetcdにデータを保存する際に暗号化するための設定ファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ENCRYPTION_KEY<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>head -c <span style="color:#ae81ff">32</span> /dev/urandom | base64<span style="color:#66d9ef">)</span>

cat &gt; encryption-config.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">kind: EncryptionConfig
</span><span style="color:#e6db74">apiVersion: v1
</span><span style="color:#e6db74">resources:
</span><span style="color:#e6db74">  - resources:
</span><span style="color:#e6db74">      - secrets
</span><span style="color:#e6db74">    providers:
</span><span style="color:#e6db74">      - aescbc:
</span><span style="color:#e6db74">          keys:
</span><span style="color:#e6db74">            - name: key1
</span><span style="color:#e6db74">              secret: ${ENCRYPTION_KEY}
</span><span style="color:#e6db74">      - identity: {}
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p> </p>
<h3 id="各種証明書とkubeconfigの転送">各種証明書とkubeconfigの転送</h3>
<p>下記のスクリプトを実行し、マスターノードに必要な各種証明書とkubeconfigを転送します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
MASTER1_HOSTNAME<span style="color:#f92672">=</span>k8s-master1
MASTER2_HOSTNAME<span style="color:#f92672">=</span>k8s-master2
MASTER3_HOSTNAME<span style="color:#f92672">=</span>k8s-master3

<span style="color:#66d9ef">for</span> instance in <span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
    echo
    echo <span style="color:#e6db74">&#34;Sending files to </span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    echo

    scp <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-peer-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-peer-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-etcd-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-etcd-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-healthcheck-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-kubelet-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-apiserver-kubelet-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kubernetes-front-proxy-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/front-proxy-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/front-proxy-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/service-account.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/service-account-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        kubeconfig/admin.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        kubeconfig/kube-controller-manager.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        kubeconfig/kube-scheduler.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        encryption-config.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        ubuntu@<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>:/home/ubuntu

    echo
    echo <span style="color:#e6db74">&#34;Complete to send files to </span><span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>


<span style="color:#66d9ef">done</span>

exit <span style="color:#ae81ff">0</span>
</code></pre></div><p> </p>
<p>次に、下記のスクリプトを実行し、ワーカーノードに必要な各種証明書とkubeconfigを転送します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
MASTER1_HOSTNAME<span style="color:#f92672">=</span>k8s-master1
MASTER2_HOSTNAME<span style="color:#f92672">=</span>k8s-master2
MASTER3_HOSTNAME<span style="color:#f92672">=</span>k8s-master3
WORKER1_HOSTNAME<span style="color:#f92672">=</span>k8s-worker1
WORKER2_HOSTNAME<span style="color:#f92672">=</span>k8s-worker2
WORKER3_HOSTNAME<span style="color:#f92672">=</span>k8s-worker3
WORKER4_HOSTNAME<span style="color:#f92672">=</span>k8s-worker4
WORKER5_HOSTNAME<span style="color:#f92672">=</span>k8s-worker5


<span style="color:#66d9ef">for</span> instance in <span style="color:#e6db74">${</span>MASTER1_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER2_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MASTER3_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER1_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER2_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER3_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER4_HOSTNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>WORKER5_HOSTNAME<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
    scp <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        cert/kubernetes-front-proxy-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        kubeconfig/<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        kubeconfig/kube-proxy.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        ubuntu@<span style="color:#e6db74">${</span>instance<span style="color:#e6db74">}</span>:/home/ubuntu
<span style="color:#66d9ef">done</span>

exit <span style="color:#ae81ff">0</span>
</code></pre></div><p> 
 </p>
<p>ローカル環境上での作業は以上です。</p>
<p> 
 </p>
<h3 id="マスターノード上での作業">マスターノード上での作業</h3>
<h3 id="etcdのデプロイ">etcdのデプロイ</h3>
<p>下記のコマンドを実行し、etcdをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ETCD_VER<span style="color:#f92672">=</span>v3.4.14
GOOGLE_URL<span style="color:#f92672">=</span>https://storage.googleapis.com/etcd
GITHUB_URL<span style="color:#f92672">=</span>https://github.com/etcd-io/etcd/releases/download
DOWNLOAD_URL<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>GOOGLE_URL<span style="color:#e6db74">}</span>

rm -f /tmp/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
rm -rf /tmp/etcd-download-test <span style="color:#f92672">&amp;&amp;</span> mkdir -p /tmp/etcd-download-test
wget -q --show-progress --https-only --timestamping <span style="color:#e6db74">${</span>DOWNLOAD_URL<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
tar xzvf etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
sudo mv etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64/etcd* /usr/local/bin/
rm -rf etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64
rm -f etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置領域の作成や証明書の配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/etcd/ <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/etcd/

sudo chmod <span style="color:#ae81ff">700</span> /var/lib/etcd

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    etcd-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-peer-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-peer-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-etcd-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-etcd-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-healthcheck-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/etcd/
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をetcd.serviceファイルとして保存します。</p>
<p><strong>なお、下記の内容はマスターノードであるk8s-worker1用のユニットファイルです。</strong></p>
<p><strong>他のマスターノードに対して作成する場合には以下のパラメータを変更します。</strong></p>
<ul>
<li>&ndash;name</li>
<li>&ndash;cert-file</li>
<li>&ndash;key-file</li>
<li>&ndash;peer-cert-file</li>
<li>&ndash;peer-key-file</li>
<li>&ndash;initial-advertise-peer-urls</li>
<li>&ndash;listen-peer-urls</li>
<li>&ndash;listen-client-urls</li>
<li>&ndash;advertise-client-urls</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/etcd.service" data-lang=":/etc/systemd/system/etcd.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">etcd</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://etcd.io/docs/</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">notify</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/etcd </span>\
<span style="color:#e6db74">  --name etcd-k8s-master1 </span>\
<span style="color:#e6db74">  --cert-file=/etc/etcd/kube-etcd-k8s-master1.pem </span>\
<span style="color:#e6db74">  --key-file=/etc/etcd/kube-etcd-k8s-master1-key.pem </span>\
<span style="color:#e6db74">  --peer-cert-file=/etc/etcd/kube-etcd-peer-k8s-master1.pem </span>\
<span style="color:#e6db74">  --peer-key-file=/etc/etcd/kube-etcd-peer-k8s-master1-key.pem </span>\
<span style="color:#e6db74">  --trusted-ca-file=/etc/etcd/etcd-ca.pem </span>\
<span style="color:#e6db74">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.pem </span>\
<span style="color:#e6db74">  --peer-client-cert-auth </span>\
<span style="color:#e6db74">  --client-cert-auth </span>\
<span style="color:#e6db74">  --initial-advertise-peer-urls https://172.29.156.11:2380 </span>\
<span style="color:#e6db74">  --listen-peer-urls https://172.29.156.11:2380 </span>\
<span style="color:#e6db74">  --listen-client-urls https://172.29.156.11:2379,https://127.0.0.1:2379 </span>\
<span style="color:#e6db74">  --advertise-client-urls https://172.29.156.11:2379 </span>\
<span style="color:#e6db74">  --initial-cluster-token etcd-k8s </span>\
<span style="color:#e6db74">  --initial-cluster etcd-k8s-master1=https://172.29.156.11:2380,etcd-k8s-master2=https://172.29.156.12:2380,etcd-k8s-master3=https://172.29.156.13:2380 </span>\
<span style="color:#e6db74">  --initial-cluster-state new </span>\
<span style="color:#e6db74">  --data-dir=/var/lib/etcd </span>\
<span style="color:#e6db74">  --enable-v2=true</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
<span style="color:#a6e22e">Environment</span><span style="color:#f92672">=</span><span style="color:#e6db74">ETCD_UNSUPPORTED_ARCH=arm64</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、etcdを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable etcd
sudo systemctl start etcd
</code></pre></div><p> </p>
<p>etcdに対してヘルスチェックを行います。</p>
<p>下記のような応答があればetcdは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /etc/etcd/kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /etc/etcd/kube-etcd-healthcheck-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://127.0.0.1:2379/health
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p> </p>
<p>etcdの状態を確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ etcdctl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    endpoint status <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --write-out<span style="color:#f92672">=</span>table <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /etc/etcd/kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /etc/etcd/kube-etcd-healthcheck-client-key.pem
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|    ENDPOINT    |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| 127.0.0.1:2379 | 9be5988db9f26062 |  3.4.14 |   <span style="color:#ae81ff">20</span> kB |      true |      false |         <span style="color:#ae81ff">3</span> |          <span style="color:#ae81ff">8</span> |                  <span style="color:#ae81ff">8</span> |        |
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div><p> </p>
<p>全てのマスターノード上にetcdをデプロイした後、etcdの状態を確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ etcdctl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    endpoint status <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --write-out<span style="color:#f92672">=</span>table <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --endpoints<span style="color:#f92672">=</span>172.29.156.11:2379,172.29.156.12:2379,172.29.156.13:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /etc/etcd/kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /etc/etcd/kube-etcd-healthcheck-client-key.pem
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| 172.29.156.11:2379 | 9be5988db9f26062 |  3.4.14 |   <span style="color:#ae81ff">20</span> kB |      true |      false |         <span style="color:#ae81ff">3</span> |          <span style="color:#ae81ff">8</span> |                  <span style="color:#ae81ff">8</span> |        |
| 172.29.156.12:2379 | 6aed71a3afc07c5c |  3.4.14 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">3</span> |          <span style="color:#ae81ff">8</span> |                  <span style="color:#ae81ff">8</span> |        |
| 172.29.156.13:2379 | 6b563b7eb08ebf26 |  3.4.14 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">3</span> |          <span style="color:#ae81ff">8</span> |                  <span style="color:#ae81ff">8</span> |        |
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div><p> </p>
<h3 id="kube-apiserverのデプロイ">kube-apiserverのデプロイ</h3>
<p>下記のコマンドを実行し、kube-apiserverをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping https://dl.k8s.io/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kube-apiserver
sudo chmod +x kube-apiserver
sudo mv kube-apiserver /usr/local/bin
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置領域の作成や設定ファイルの配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/kubernetes/config/ <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubernetes-ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-<span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-kubelet-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-apiserver-kubelet-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubernetes-front-proxy-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    front-proxy-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    front-proxy-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    service-account.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    service-account-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    encryption-config.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をkube-apiserver.serviceファイルとして保存します。</p>
<p><strong>なお、下記の内容はマスターノードであるk8s-worker1用のユニットファイルです。</strong></p>
<p><strong>他のマスターノードに対して作成する場合には以下のパラメータを変更します。</strong></p>
<ul>
<li>&ndash;advertise-address</li>
<li>&ndash;tls-cert-file</li>
<li>&ndash;tls-private-key-file</li>
</ul>
<p>&ndash;service-cluster-ip-rangeパラメータにはClusterIP用サブネットを指定します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/kube-apiserver.service" data-lang=":/etc/systemd/system/kube-apiserver.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes API Server</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-apiserver </span>\
<span style="color:#e6db74">  --advertise-address=172.29.156.11 </span>\
<span style="color:#e6db74">  --allow-privileged=true </span>\
<span style="color:#e6db74">  --apiserver-count=3 </span>\
<span style="color:#e6db74">  --audit-log-maxage=31 </span>\
<span style="color:#e6db74">  --audit-log-maxbackup=14 </span>\
<span style="color:#e6db74">  --audit-log-maxsize=1000 </span>\
<span style="color:#e6db74">  --audit-log-path=/var/log/audit.log </span>\
<span style="color:#e6db74">  --authorization-mode=Node,RBAC </span>\
<span style="color:#e6db74">  --bind-address=0.0.0.0 </span>\
<span style="color:#e6db74">  --client-ca-file=/var/lib/kubernetes/kubernetes-ca.pem </span>\
<span style="color:#e6db74">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,StorageObjectInUseProtection,PersistentVolumeClaimResize,RuntimeClass,CertificateApproval,CertificateSigning,CertificateSubjectRestriction,DefaultIngressClass,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota </span>\
<span style="color:#e6db74">  --etcd-cafile=/etc/etcd/etcd-ca.pem </span>\
<span style="color:#e6db74">  --etcd-certfile=/etc/etcd/kube-apiserver-etcd-client.pem </span>\
<span style="color:#e6db74">  --etcd-keyfile=/etc/etcd/kube-apiserver-etcd-client-key.pem </span>\
<span style="color:#e6db74">  --etcd-servers=https://172.29.156.11:2379,https://172.29.156.12:2379,https://172.29.156.13:2379 </span>\
<span style="color:#e6db74">  --event-ttl=1h </span>\
<span style="color:#e6db74">  --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml </span>\
<span style="color:#e6db74">  --kubelet-certificate-authority=/var/lib/kubernetes/kubernetes-ca.pem </span>\
<span style="color:#e6db74">  --kubelet-client-certificate=/var/lib/kubernetes/kube-apiserver-kubelet-client.pem </span>\
<span style="color:#e6db74">  --kubelet-client-key=/var/lib/kubernetes/kube-apiserver-kubelet-client-key.pem </span>\
<span style="color:#e6db74">  --kubelet-https=true </span>\
<span style="color:#e6db74">  --runtime-config=&#39;api/all=true&#39; </span>\
<span style="color:#e6db74">  --service-account-key-file=/var/lib/kubernetes/service-account.pem </span>\
<span style="color:#e6db74">  --service-account-signing-key-file=/var/lib/kubernetes/service-account-key.pem </span>\
<span style="color:#e6db74">  --service-account-issuer=api </span>\
<span style="color:#e6db74">  --api-audiences=api </span>\
<span style="color:#e6db74">  --service-cluster-ip-range=10.96.0.0/12 </span>\
<span style="color:#e6db74">  --service-node-port-range=30000-32767 </span>\
<span style="color:#e6db74">  --tls-cert-file=/var/lib/kubernetes/kube-apiserver-k8s-master1.pem </span>\
<span style="color:#e6db74">  --tls-private-key-file=/var/lib/kubernetes/kube-apiserver-k8s-master1-key.pem </span>\
<span style="color:#e6db74">  --requestheader-client-ca-file=/var/lib/kubernetes/kubernetes-front-proxy-ca.pem </span>\
<span style="color:#e6db74">  --requestheader-allowed-names=front-proxy-client </span>\
<span style="color:#e6db74">  --requestheader-extra-headers-prefix=X-Remote-Extra- </span>\
<span style="color:#e6db74">  --requestheader-group-headers=X-Remote-Group </span>\
<span style="color:#e6db74">  --requestheader-username-headers=X-Remote-User </span>\
<span style="color:#e6db74">  --proxy-client-cert-file=/var/lib/kubernetes/front-proxy-client.pem </span>\
<span style="color:#e6db74">  --proxy-client-key-file=/var/lib/kubernetes/front-proxy-client-key.pem </span>\
<span style="color:#e6db74">  --v=2 </span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、kube-apiserverを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable kube-apiserver
sudo systemctl start kube-apiserver
</code></pre></div><p> </p>
<p>kube-apiserverに対してヘルスチェックを行います。</p>
<p>下記のような応答があればkube-apiserverは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /var/lib/kubernetes/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /var/lib/kubernetes/kube-apiserver-kubelet-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /var/lib/kubernetes/kube-apiserver-kubelet-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://127.0.0.1:6443/healthz
ok
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /var/lib/kubernetes/kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /var/lib/kubernetes/kube-apiserver-kubelet-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /var/lib/kubernetes/kube-apiserver-kubelet-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://127.0.0.1:6443/livez
ok
</code></pre></div><p> </p>
<h3 id="kube-controller-managerのデプロイ">kube-controller-managerのデプロイ</h3>
<p>下記のコマンドを実行し、kube-controller-managerをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping https://dl.k8s.io/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kube-controller-manager
sudo chmod +x kube-controller-manager
sudo mv kube-controller-manager /usr/local/bin
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-controller-manager.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をkube-controller-manager.serviceファイルとして保存します。</p>
<p>&ndash;cluster-cidrパラメータにはPod用のサブネットを、
&ndash;service-cluster-ip-rangeパラメータにはClusterIP用サブネットを指定します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/kube-controller-manager.service" data-lang=":/etc/systemd/system/kube-controller-manager.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Controller Manager</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-controller-manager </span>\
<span style="color:#e6db74">  --bind-address=0.0.0.0 </span>\
<span style="color:#e6db74">  --allocate-node-cidrs=true </span>\
<span style="color:#e6db74">  --cluster-cidr=10.244.0.0/16 </span>\
<span style="color:#e6db74">  --cluster-name=kubernetes </span>\
<span style="color:#e6db74">  --cluster-signing-cert-file=/var/lib/kubernetes/kubernetes-ca.pem </span>\
<span style="color:#e6db74">  --cluster-signing-key-file=/var/lib/kubernetes/kubernetes-ca-key.pem </span>\
<span style="color:#e6db74">  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig </span>\
<span style="color:#e6db74">  --leader-elect=true </span>\
<span style="color:#e6db74">  --leader-elect-lease-duration=15s </span>\
<span style="color:#e6db74">  --leader-elect-renew-deadline=10s </span>\
<span style="color:#e6db74">  --leader-elect-resource-lock=leases </span>\
<span style="color:#e6db74">  --leader-elect-resource-name=kube-controller-manager </span>\
<span style="color:#e6db74">  --leader-elect-resource-namespace=kube-system </span>\
<span style="color:#e6db74">  --leader-elect-retry-period=2s </span>\
<span style="color:#e6db74">  --client-ca-file=/var/lib/kubernetes/kubernetes-ca.pem </span>\
<span style="color:#e6db74">  --root-ca-file=/var/lib/kubernetes/kubernetes-ca.pem </span>\
<span style="color:#e6db74">  --requestheader-client-ca-file=/var/lib/kubernetes/kubernetes-front-proxy-ca.pem </span>\
<span style="color:#e6db74">  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem </span>\
<span style="color:#e6db74">  --service-cluster-ip-range=10.96.0.0/12 </span>\
<span style="color:#e6db74">  --use-service-account-credentials=true </span>\
<span style="color:#e6db74">  --v=2</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、kube-controller-managerを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable kube-controller-manager
sudo systemctl start kube-controller-manager
</code></pre></div><p> </p>
<p>kube-controller-managerに対してヘルスチェックを行います。</p>
<p>下記のような応答があればkube-controller-managerは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl http://localhost:10252/healthz
ok
</code></pre></div><p> </p>
<p>全てのマスターノード上へのkube-controller-managerのデプロイ後、リーダー選出が行われます。</p>
<p>下記のコマンドを実行することでリーダーかどうか確認することができます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -s http://localhost:10252/metrics | grep leader
<span style="color:#75715e"># HELP leader_election_master_status [ALPHA] Gauge of if the reporting system is master of the relevant lease, 0 indicates backup, 1 indicates master. &#39;name&#39; is the string used to identify the lease. Please make sure to group by name.</span>
<span style="color:#75715e"># TYPE leader_election_master_status gauge</span>
leader_election_master_status<span style="color:#f92672">{</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kube-controller-manager&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p> </p>
<h3 id="kube-schedulerのデプロイ">kube-schedulerのデプロイ</h3>
<p>下記のコマンドを実行し、kube-schedulerをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping https://dl.k8s.io/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kube-scheduler
sudo chmod +x kube-scheduler
sudo mv kube-scheduler /usr/local/bin
</code></pre></div><p> </p>
<p>kube-schedulerのパラメータを設定する設定ファイルを作成します。</p>
<p>下記の内容をkube-scheduler.yamlファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:kube-scheduler.yaml" data-lang=":kube-scheduler.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubescheduler.config.k8s.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeSchedulerConfiguration</span>
<span style="color:#f92672">clientConnection</span>:
  <span style="color:#f92672">kubeconfig</span>: <span style="color:#e6db74">&#34;/var/lib/kubernetes/kube-scheduler.kubeconfig&#34;</span>
<span style="color:#f92672">leaderElection</span>:
  <span style="color:#f92672">leaderElect</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">leaseDuration</span>: <span style="color:#ae81ff">15s</span>
  <span style="color:#f92672">renewDeadline</span>: <span style="color:#ae81ff">10s</span>
  <span style="color:#f92672">retryPeriod</span>: <span style="color:#ae81ff">2s</span>
  <span style="color:#f92672">resourceLock</span>: <span style="color:#ae81ff">leases</span>
  <span style="color:#f92672">resourceName</span>: <span style="color:#ae81ff">kube-scheduler</span>
  <span style="color:#f92672">resourceNamespace</span>: <span style="color:#ae81ff">kube-system</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-scheduler.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/

sudo mv  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-scheduler.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/kubernetes/config/
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をkube-controller-scheduler.serviceファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/kube-scheduler.service" data-lang=":/etc/systemd/system/kube-scheduler.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Scheduler</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-scheduler </span>\
<span style="color:#e6db74">  --config=/etc/kubernetes/config/kube-scheduler.yaml </span>\
<span style="color:#e6db74">  --v=2</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、kube-schedulerを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable kube-scheduler
sudo systemctl start kube-scheduler
</code></pre></div><p> </p>
<p>kube-schedulerに対してヘルスチェックを行います。</p>
<p>下記のような応答があればkube-schedulerは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl http://localhost:10251/healthz
ok
</code></pre></div><p> </p>
<p>全てのマスターノード上へのkube-schedulerのデプロイ後、リーダー選出が行われます。</p>
<p>下記のコマンドを実行することでリーダーかどうか確認することができます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -s http://localhost:10251/metrics | grep leader
<span style="color:#75715e"># HELP leader_election_master_status [ALPHA] Gauge of if the reporting system is master of the relevant lease, 0 indicates backup, 1 indicates master. &#39;name&#39; is the string used to identify the lease. Please make sure to group by name.</span>
<span style="color:#75715e"># TYPE leader_election_master_status gauge</span>
leader_election_master_status<span style="color:#f92672">{</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kube-scheduler&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p> </p>
<h3 id="kubectlのインストール">kubectlのインストール</h3>
<p>下記のコマンドを実行し、kubectlをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping https://dl.k8s.io/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kubectl
sudo chmod +x kubectl
sudo mv kubectl /usr/local/bin
</code></pre></div><p> </p>
<p>下記のコマンドを実行することでkubectlコマンドを通してKubernetesクラスターに接続できるように設定します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    .kube/
chown ubuntu:ubuntu .kube/
mv admin.kubeconfig .kube/config
</code></pre></div><p> </p>
<p>kubeletコマンドを通して、Kubernetesの各コンポーネントが認識されているか確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</code></pre></div><p> </p>
<h3 id="ロードバランサーの構築">ロードバランサーの構築</h3>
<h3 id="keepalivedのデプロイ">Keepalivedのデプロイ</h3>
<p>下記のコマンドを実行し、Keepalivedをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install -y keepalived<span style="color:#f92672">=</span>1:2.0.19-2
</code></pre></div><p> </p>
<p>Keepalivedの設定ファイルを作成します。</p>
<p>下記の内容を/etc/keepalivedファルダ配下にkeepalived.confファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:.cfg" data-lang=":.cfg"><span style="color:#a6e22e">vrrp_script chk_haproxy {</span>
    <span style="color:#a6e22e">script   &#34;systemctl is-active haproxy&#34;</span>
    <span style="color:#a6e22e">interval 1</span>
    <span style="color:#a6e22e">rise     2</span>
    <span style="color:#a6e22e">fall     3</span>
<span style="color:#a6e22e">}</span>

<span style="color:#a6e22e">vrrp_instance HA-CLUSTER {</span>
    <span style="color:#a6e22e">state BACKUP</span>
    <span style="color:#a6e22e">nopreempt</span>
    <span style="color:#a6e22e">interface eth0</span>
    <span style="color:#a6e22e">virtual_router_id 1</span>
    <span style="color:#a6e22e">priority 100</span>
    <span style="color:#a6e22e">advert_int 1</span>
    <span style="color:#a6e22e">virtual_ipaddress {</span>
        <span style="color:#a6e22e">172.29.156.10</span>
    <span style="color:#a6e22e">}</span>
    <span style="color:#a6e22e">track_script {</span>
        <span style="color:#a6e22e">chk_haproxy</span>
    <span style="color:#a6e22e">}</span>
<span style="color:#a6e22e">}</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、Keepalivedを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable keepalived
sudo systemctl start keepalived
</code></pre></div><p> </p>
<p>Keepalivedが動作していることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl is-active keepalived
active
</code></pre></div><p> </p>
<h3 id="haproxyのデプロイ">HAproxyのデプロイ</h3>
<p>下記のコマンドを実行し、HAProxyをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install -y haproxy<span style="color:#f92672">=</span>2.0.13-2ubuntu0.1
</code></pre></div><p> </p>
<p>HAProxyの設定ファイルを作成します。</p>
<p>下記の内容を/etc/haproxyファルダ配下にhaproxy.cfgファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:.cfg" data-lang=":.cfg"><span style="color:#a6e22e">global</span>
    <span style="color:#a6e22e">log /dev/log    local0</span>
    <span style="color:#a6e22e">log /dev/log    local1 notice</span>
    <span style="color:#a6e22e">chroot /var/lib/haproxy</span>
    <span style="color:#a6e22e">stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span>
    <span style="color:#a6e22e">stats timeout 30s</span>
    <span style="color:#a6e22e">user haproxy</span>
    <span style="color:#a6e22e">group haproxy</span>
    <span style="color:#a6e22e">daemon</span>
    <span style="color:#a6e22e">ca-base /etc/ssl/certs</span>
    <span style="color:#a6e22e">crt-base /etc/ssl/private</span>
    <span style="color:#a6e22e">ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS</span>
    <span style="color:#a6e22e">ssl-default-bind-options no-sslv3</span>


<span style="color:#a6e22e">defaults</span>
    <span style="color:#a6e22e">log global</span>
    <span style="color:#a6e22e">mode tcp</span>
    <span style="color:#a6e22e">option tcp-check</span>
    <span style="color:#a6e22e">option tcplog</span>
    <span style="color:#a6e22e">option  dontlognull</span>
    <span style="color:#a6e22e">retries 6</span>
    <span style="color:#a6e22e">timeout connect 30000ms</span>
    <span style="color:#a6e22e">timeout client  3000ms</span>
    <span style="color:#a6e22e">timeout server  3000ms</span>
    <span style="color:#a6e22e">errorfile 400 /etc/haproxy/errors/400.http</span>
    <span style="color:#a6e22e">errorfile 403 /etc/haproxy/errors/403.http</span>
    <span style="color:#a6e22e">errorfile 408 /etc/haproxy/errors/408.http</span>
    <span style="color:#a6e22e">errorfile 500 /etc/haproxy/errors/500.http</span>
    <span style="color:#a6e22e">errorfile 502 /etc/haproxy/errors/502.http</span>
    <span style="color:#a6e22e">errorfile 503 /etc/haproxy/errors/503.http</span>
    <span style="color:#a6e22e">errorfile 504 /etc/haproxy/errors/504.http</span>


<span style="color:#a6e22e">frontend kube-apiserver</span>
    <span style="color:#a6e22e">bind *:9000</span>
    <span style="color:#a6e22e">default_backend kube-apiserver</span>


<span style="color:#a6e22e">backend kube-apiserver</span>
    <span style="color:#a6e22e">balance roundrobin</span>
    <span style="color:#a6e22e">option redispatch</span>
    <span style="color:#a6e22e">server k8s-master1 172.29.156.11:6443 check inter 3000ms rise 2 fall 3</span>
    <span style="color:#a6e22e">server k8s-master2 172.29.156.12:6443 check inter 3000ms rise 2 fall 3</span>
    <span style="color:#a6e22e">server k8s-master3 172.29.156.13:6443 check inter 3000ms rise 2 fall 3</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、HAProxyを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable haproxy
sudo systemctl start haproxy
</code></pre></div><p> </p>
<p>HAProxyが動作していることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl is-active haproxy
active
</code></pre></div><p> </p>
<h3 id="flanneldを機能させるための準備">flanneldを機能させるための準備</h3>
<p>下記のコマンドを実行し、flanneldを機能させるための設定をetcdサーバに保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -X PUT <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /etc/etcd/kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /etc/etcd/kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -d value<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{ &#34;Network&#34;: &#34;10.244.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;vxlan&#34;}}&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://127.0.0.1:2379/v2/keys/coreos.com/network/config
</code></pre></div><p> </p>
<p>etcdサーバ上にflanneldの設定が保存されていることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -s <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cert /etc/etcd/kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --key /etc/etcd/kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://127.0.0.1:2379/v2/keys/coreos.com/network/config <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    | jq
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;get&#34;</span>,
  <span style="color:#e6db74">&#34;node&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;/coreos.com/network/config&#34;</span>,
    <span style="color:#e6db74">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;{ \&#34;Network\&#34;: \&#34;10.244.0.0/16\&#34;, \&#34;Backend\&#34;: {\&#34;Type\&#34;: \&#34;vxlan\&#34;}}&#34;</span>,
    <span style="color:#e6db74">&#34;modifiedIndex&#34;</span>: 9,
    <span style="color:#e6db74">&#34;createdIndex&#34;</span>: <span style="color:#ae81ff">9</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p> 
 </p>
<p>マスターノード上での作業は以上です。</p>
<p> 
 </p>
<h3 id="ワーカーノード上での作業">ワーカーノード上での作業</h3>
<h3 id="事前準備">事前準備</h3>
<p>cgroupsのMemory Subsystemを有効化します。
/boot/firmware/cmdline.txtに下記を追記して再起動してください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/boot/firmware/cmdline.txt" data-lang=":/boot/firmware/cmdline.txt">cgroup_memory=1 cgroup_enable=memory
</code></pre></div><p> </p>
<p>次に、依存関係のあるパッケージをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt update
sudo apt -y install socat conntrack ipset
</code></pre></div><p> </p>
<h3 id="証明書配置領域の作成と各種証明書の配置">証明書配置領域の作成と各種証明書の配置</h3>
<p>下記のコマンドを実行し、証明書の配置領域の作成と各種証明書の配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/etcd/ <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/

sudo mv  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-flanneld-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-etcd-flanneld-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/etcd/

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubernetes-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubernetes-front-proxy-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubernetes/
</code></pre></div><p> </p>
<h3 id="cni-pluginsとcrictlのインストール">cni-pluginsとcrictlのインストール</h3>
<p>下記のコマンドを実行し、cni-pluginsとcrictlをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/cni/net.d/ <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /opt/cni/bin/ 

wget -q --show-progress --https-only --timestamping <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-arm64-v0.9.1.tgz

sudo tar -xvf cni-plugins-linux-arm64-v0.9.1.tgz -C /opt/cni/bin/

wget -q --show-progress --https-only --timestamping <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-arm64.tar.gz

tar -xvf crictl-v1.20.0-linux-arm64.tar.gz
chmod +x crictl
sudo mv crictl /usr/local/bin/

rm crictl-v1.20.0-linux-arm64.tar.gz cni-plugins-linux-arm64-v0.9.1.tgz
</code></pre></div><p> </p>
<h3 id="containerdとruncのインストール">containerdとruncのインストール</h3>
<p>containerdとruncをインストールする前に下記のコマンドを実行し、必要な設定を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span style="color:#e6db74">overlay
</span><span style="color:#e6db74">br_netfilter
</span><span style="color:#e6db74">EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter

cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables  = 1
</span><span style="color:#e6db74">net.ipv4.ip_forward                 = 1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#e6db74">EOF</span>

sudo sysctl --system
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、containerdとruncをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install -y <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    containerd<span style="color:#f92672">=</span>1.3.3-0ubuntu2.3 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    runc<span style="color:#f92672">=</span>1.0.0~rc10-0ubuntu1
</code></pre></div><p> </p>
<p>/etc/containerdフォルダを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /etc/containerd/
</code></pre></div><p> </p>
<p>/etc/containerdフォルダ配下に下記の内容をconfig.tomlファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:config.toml" data-lang=":config.toml"><span style="color:#a6e22e">version</span> = <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">root</span> = <span style="color:#e6db74">&#34;/var/lib/containerd&#34;</span>
<span style="color:#a6e22e">state</span> = <span style="color:#e6db74">&#34;/run/containerd&#34;</span>
<span style="color:#a6e22e">plugin_dir</span> = <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">disabled_plugins</span> = []
<span style="color:#a6e22e">required_plugins</span> = []
<span style="color:#a6e22e">oom_score</span> = <span style="color:#ae81ff">0</span>

[<span style="color:#a6e22e">grpc</span>]
  <span style="color:#a6e22e">address</span> = <span style="color:#e6db74">&#34;/run/containerd/containerd.sock&#34;</span>
  <span style="color:#a6e22e">tcp_address</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">tcp_tls_cert</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">tcp_tls_key</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">uid</span> = <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">gid</span> = <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">max_recv_message_size</span> = <span style="color:#ae81ff">16777216</span>
  <span style="color:#a6e22e">max_send_message_size</span> = <span style="color:#ae81ff">16777216</span>

[<span style="color:#a6e22e">ttrpc</span>]
  <span style="color:#a6e22e">address</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">uid</span> = <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">gid</span> = <span style="color:#ae81ff">0</span>

[<span style="color:#a6e22e">debug</span>]
  <span style="color:#a6e22e">address</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">uid</span> = <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">gid</span> = <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">level</span> = <span style="color:#e6db74">&#34;&#34;</span>

[<span style="color:#a6e22e">metrics</span>]
  <span style="color:#a6e22e">address</span> = <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#a6e22e">grpc_histogram</span> = <span style="color:#66d9ef">false</span>

[<span style="color:#a6e22e">cgroup</span>]
  <span style="color:#a6e22e">path</span> = <span style="color:#e6db74">&#34;&#34;</span>

[<span style="color:#a6e22e">timeouts</span>]
  <span style="color:#e6db74">&#34;io.containerd.timeout.shim.cleanup&#34;</span> = <span style="color:#e6db74">&#34;5s&#34;</span>
  <span style="color:#e6db74">&#34;io.containerd.timeout.shim.load&#34;</span> = <span style="color:#e6db74">&#34;5s&#34;</span>
  <span style="color:#e6db74">&#34;io.containerd.timeout.shim.shutdown&#34;</span> = <span style="color:#e6db74">&#34;3s&#34;</span>
  <span style="color:#e6db74">&#34;io.containerd.timeout.task.state&#34;</span> = <span style="color:#e6db74">&#34;2s&#34;</span>

[<span style="color:#a6e22e">plugins</span>]
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.gc.v1.scheduler&#34;</span>]
    <span style="color:#a6e22e">pause_threshold</span> = <span style="color:#ae81ff">0.02</span>
    <span style="color:#a6e22e">deletion_threshold</span> = <span style="color:#ae81ff">0</span>
    <span style="color:#a6e22e">mutation_threshold</span> = <span style="color:#ae81ff">100</span>
    <span style="color:#a6e22e">schedule_delay</span> = <span style="color:#e6db74">&#34;0s&#34;</span>
    <span style="color:#a6e22e">startup_delay</span> = <span style="color:#e6db74">&#34;100ms&#34;</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>]
    <span style="color:#a6e22e">disable_tcp_service</span> = <span style="color:#66d9ef">true</span>
    <span style="color:#a6e22e">stream_server_address</span> = <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
    <span style="color:#a6e22e">stream_server_port</span> = <span style="color:#e6db74">&#34;0&#34;</span>
    <span style="color:#a6e22e">stream_idle_timeout</span> = <span style="color:#e6db74">&#34;4h0m0s&#34;</span>
    <span style="color:#a6e22e">enable_selinux</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">sandbox_image</span> = <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.1&#34;</span>
    <span style="color:#a6e22e">stats_collect_period</span> = <span style="color:#ae81ff">10</span>
    <span style="color:#a6e22e">enable_tls_streaming</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">max_container_log_line_size</span> = <span style="color:#ae81ff">16384</span>
    <span style="color:#a6e22e">disable_cgroup</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">disable_apparmor</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">restrict_oom_score_adj</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">max_concurrent_downloads</span> = <span style="color:#ae81ff">3</span>
    <span style="color:#a6e22e">disable_proc_mount</span> = <span style="color:#66d9ef">false</span>
    [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>]
      <span style="color:#a6e22e">snapshotter</span> = <span style="color:#e6db74">&#34;overlayfs&#34;</span>
      <span style="color:#a6e22e">default_runtime_name</span> = <span style="color:#e6db74">&#34;runc&#34;</span>
      <span style="color:#a6e22e">no_pivot</span> = <span style="color:#66d9ef">false</span>
      [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">default_runtime</span>]
        <span style="color:#a6e22e">runtime_type</span> = <span style="color:#e6db74">&#34;io.containerd.runtime.v1.linux&#34;</span>
        <span style="color:#a6e22e">runtime_engine</span> = <span style="color:#e6db74">&#34;/usr/sbin/runc&#34;</span>
        <span style="color:#a6e22e">runtime_root</span> = <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#a6e22e">privileged_without_host_devices</span> = <span style="color:#66d9ef">false</span>
      [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">untrusted_workload_runtime</span>]
        <span style="color:#a6e22e">runtime_type</span> = <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#a6e22e">runtime_engine</span> = <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#a6e22e">runtime_root</span> = <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#a6e22e">privileged_without_host_devices</span> = <span style="color:#66d9ef">false</span>
      [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>]
        [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>]
          <span style="color:#a6e22e">runtime_type</span> = <span style="color:#e6db74">&#34;io.containerd.runc.v1&#34;</span>
          <span style="color:#a6e22e">runtime_engine</span> = <span style="color:#e6db74">&#34;&#34;</span>
          <span style="color:#a6e22e">runtime_root</span> = <span style="color:#e6db74">&#34;&#34;</span>
          <span style="color:#a6e22e">privileged_without_host_devices</span> = <span style="color:#66d9ef">false</span>
      [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>.<span style="color:#a6e22e">options</span>]
            <span style="color:#a6e22e">SystemdCgroup</span> = <span style="color:#66d9ef">true</span>
    [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">cni</span>]
      <span style="color:#a6e22e">bin_dir</span> = <span style="color:#e6db74">&#34;/opt/cni/bin&#34;</span>
      <span style="color:#a6e22e">conf_dir</span> = <span style="color:#e6db74">&#34;/etc/cni/net.d&#34;</span>
      <span style="color:#a6e22e">max_conf_num</span> = <span style="color:#ae81ff">1</span>
      <span style="color:#a6e22e">conf_template</span> = <span style="color:#e6db74">&#34;&#34;</span>
    [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">registry</span>]
      [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">mirrors</span>]
        [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">mirrors</span>.<span style="color:#e6db74">&#34;docker.io&#34;</span>]
          <span style="color:#a6e22e">endpoint</span> = [<span style="color:#e6db74">&#34;https://registry-1.docker.io&#34;</span>]
    [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">x509_key_pair_streaming</span>]
      <span style="color:#a6e22e">tls_cert_file</span> = <span style="color:#e6db74">&#34;&#34;</span>
      <span style="color:#a6e22e">tls_key_file</span> = <span style="color:#e6db74">&#34;&#34;</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.internal.v1.opt&#34;</span>]
    <span style="color:#a6e22e">path</span> = <span style="color:#e6db74">&#34;/opt/containerd&#34;</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.internal.v1.restart&#34;</span>]
    <span style="color:#a6e22e">interval</span> = <span style="color:#e6db74">&#34;10s&#34;</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.metadata.v1.bolt&#34;</span>]
    <span style="color:#a6e22e">content_sharing_policy</span> = <span style="color:#e6db74">&#34;shared&#34;</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.monitor.v1.cgroups&#34;</span>]
    <span style="color:#a6e22e">no_prometheus</span> = <span style="color:#66d9ef">false</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.runtime.v1.linux&#34;</span>]
    <span style="color:#a6e22e">shim</span> = <span style="color:#e6db74">&#34;containerd-shim&#34;</span>
    <span style="color:#a6e22e">runtime</span> = <span style="color:#e6db74">&#34;runc&#34;</span>
    <span style="color:#a6e22e">runtime_root</span> = <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#a6e22e">no_shim</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">shim_debug</span> = <span style="color:#66d9ef">false</span>
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.runtime.v2.task&#34;</span>]
    <span style="color:#a6e22e">platforms</span> = [<span style="color:#e6db74">&#34;linux/arm64/v8&#34;</span>]
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.service.v1.diff-service&#34;</span>]
    <span style="color:#a6e22e">default</span> = [<span style="color:#e6db74">&#34;walking&#34;</span>]
  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.snapshotter.v1.devmapper&#34;</span>]
    <span style="color:#a6e22e">root_path</span> = <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#a6e22e">pool_name</span> = <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#a6e22e">base_image_size</span> = <span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p> </p>
<h3 id="kubeletのデプロイ">kubeletのデプロイ</h3>
<p>下記のコマンドを実行し、kubeletをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    https://storage.googleapis.com/kubernetes-release/release/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kubelet
chmod +x kubelet
sudo mv kubelet /usr/local/bin/
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置領域の作成と設定ファイルの配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubelet/

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubelet/kubeconfig

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span>-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kubelet-config.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kubelet/
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をkubelet.serviceファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/kubelet.service" data-lang=":/etc/systemd/system/kubelet.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Kubelet</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">containerd.service</span>
<span style="color:#a6e22e">Requires</span><span style="color:#f92672">=</span><span style="color:#e6db74">containerd.service</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kubelet </span>\
<span style="color:#e6db74">  --config=/var/lib/kubelet/kubelet-config.yaml </span>\
<span style="color:#e6db74">  --container-runtime=remote </span>\
<span style="color:#e6db74">  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock </span>\
<span style="color:#e6db74">  --image-pull-progress-deadline=3m </span>\
<span style="color:#e6db74">  --kubeconfig=/var/lib/kubelet/kubeconfig </span>\
<span style="color:#e6db74">  --register-node=true </span>\
<span style="color:#e6db74">  --v=2</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、kubeletを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable kubelet
sudo systemctl start kubelet
</code></pre></div><p> </p>
<p>kubeletに対してヘルスチェックを行います。</p>
<p>下記のような応答があればkubeletは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl localhost:10248/healthz
ok
</code></pre></div><p> </p>
<h3 id="kube-proxyのデプロイ">kube-proxyのデプロイ</h3>
<p>下記のコマンドを実行し、kube-proxyをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KUBERNETES_VERSION<span style="color:#f92672">=</span>v1.20.4

wget -q --show-progress --https-only --timestamping <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   https://storage.googleapis.com/kubernetes-release/release/<span style="color:#e6db74">${</span>KUBERNETES_VERSION<span style="color:#e6db74">}</span>/bin/linux/arm64/kube-proxy
chmod +x kube-proxy
sudo mv kube-proxy /usr/local/bin/
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、設定ファイルの配置領域の作成と設定ファイルの配置を行います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mkdir -p <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kube-proxy/

sudo mv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    kube-proxy.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /var/lib/kube-proxy/
</code></pre></div><p> </p>
<p>下記の内容を/var/lib/kube-proxyフォルダ配下にkube-proxy-config.yamlファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-/var/lib/kube-proxy/kube-proxy-config.yaml" data-lang="/var/lib/kube-proxy/kube-proxy-config.yaml"><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeProxyConfiguration</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1</span>
<span style="color:#f92672">clientConnection</span>:
  <span style="color:#f92672">kubeconfig</span>: <span style="color:#ae81ff">/var/lib/kube-proxy/kube-proxy.kubeconfig</span>
<span style="color:#f92672">mode</span>: <span style="color:#ae81ff">iptables</span>
<span style="color:#f92672">clusterCIDR</span>: <span style="color:#ae81ff">10.244.0.0</span><span style="color:#ae81ff">/16</span>
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をkube-proxy.serviceファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/kube-proxy.service" data-lang=":/etc/systemd/system/kube-proxy.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Kube Proxy</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-proxy </span>\
<span style="color:#e6db74">  --config=/var/lib/kube-proxy/kube-proxy-config.yaml</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、kube-proxyを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable kube-proxy
sudo systemctl start kube-proxy
</code></pre></div><p> </p>
<p>kube-proxyに対してヘルスチェックを行います。</p>
<p>下記のような応答があればkube-proxyは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl localhost:10256/healthz
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;lastUpdated&#34;</span>: <span style="color:#e6db74">&#34;2021-03-29 16:19:51.774807039 +0000 UTC m=+973.895724187&#34;</span>,<span style="color:#e6db74">&#34;currentTime&#34;</span>: <span style="color:#e6db74">&#34;2021-03-29 16:19:51.774807039 +0000 UTC m=+973.895724187&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p> </p>
<h3 id="flanneldのデプロイ">flanneldのデプロイ</h3>
<p>下記のコマンドを実行し、flanneldをインストールします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/flannel-io/flannel/releases/download/v0.13.0/flannel-v0.13.0-linux-arm64.tar.gz
tar -zxvf flannel-v0.13.0-linux-arm64.tar.gz
sudo mv flanneld /usr/local/bin/
rm flannel-v0.13.0-linux-arm64.tar.gz README.md mk-docker-opts.sh
</code></pre></div><p> </p>
<p>下記の内容を/etc/cni/net.dフォルダ配下に10-flannel.conflistファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:.cfg" data-lang=":.cfg"><span style="color:#a6e22e">{</span>
  <span style="color:#a6e22e">&#34;name&#34;: &#34;cbr0&#34;,</span>
  <span style="color:#a6e22e">&#34;cniVersion&#34;: &#34;0.3.1&#34;,</span>
  <span style="color:#a6e22e">&#34;plugins&#34;: [</span>
    <span style="color:#a6e22e">{</span>
      <span style="color:#a6e22e">&#34;type&#34;: &#34;flannel&#34;,</span>
      <span style="color:#a6e22e">&#34;delegate&#34;: {</span>
        <span style="color:#a6e22e">&#34;hairpinMode&#34;: true,</span>
        <span style="color:#a6e22e">&#34;isDefaultGateway&#34;: true</span>
      <span style="color:#a6e22e">}</span>
    <span style="color:#a6e22e">},</span>
    <span style="color:#a6e22e">{</span>
      <span style="color:#a6e22e">&#34;type&#34;: &#34;portmap&#34;,</span>
      <span style="color:#a6e22e">&#34;capabilities&#34;: {</span>
        <span style="color:#a6e22e">&#34;portMappings&#34;: true</span>
      <span style="color:#a6e22e">}</span>
    <span style="color:#a6e22e">}</span>
  <span style="color:#a6e22e">]</span>
<span style="color:#a6e22e">}</span>
</code></pre></div><p> </p>
<p>/etc/systemd/systemフォルダ配下にユニットファイルを作成します。</p>
<p>下記の内容をflanneld.serviceファイルとして保存します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:/etc/systemd/system/flanneld.service" data-lang=":/etc/systemd/system/flanneld.service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Flanneld overlay address etcd agent</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/flannel-io/flannel</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/flanneld </span>\
<span style="color:#e6db74">  --etcd-endpoints=https://172.29.156.11:2379,https://172.29.156.12:2379,https://172.29.156.13:2379 </span>\
<span style="color:#e6db74">  --etcd-keyfile=/etc/etcd/kube-etcd-flanneld-client-key.pem </span>\
<span style="color:#e6db74">  --etcd-certfile=/etc/etcd/kube-etcd-flanneld-client.pem </span>\
<span style="color:#e6db74">  --etcd-cafile=/etc/etcd/etcd-ca.pem </span>\
<span style="color:#e6db74">  --healthz-port=9999 </span>\
<span style="color:#e6db74">  --ip-masq=true </span>\
<span style="color:#e6db74">  --kube-subnet-mgr=false </span>\
<span style="color:#e6db74">  --v=2</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p> </p>
<p>下記のコマンドを実行し、flanneldを起動します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl daemon-reload
sudo systemctl enable flanneld
sudo systemctl start flanneld
</code></pre></div><p> </p>
<p>flanneldに対してヘルスチェックを行います。</p>
<p>下記のような応答があればflanneldは正常に動作しています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl localhost:9999/healthz
flanneld is running
</code></pre></div><p> </p>
<p>また、flanneldがPod Networkの構築を行ったことを確認します。</p>
<p>/run/flannel/subnet.envファイルに対してPod Networkの情報が記載されていれば構築が正常に行われています。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /run/flannel/subnet.env
FLANNEL_NETWORK<span style="color:#f92672">=</span>10.244.0.0/16
FLANNEL_SUBNET<span style="color:#f92672">=</span>10.244.94.1/24
FLANNEL_MTU<span style="color:#f92672">=</span><span style="color:#ae81ff">1450</span>
FLANNEL_IPMASQ<span style="color:#f92672">=</span>true
</code></pre></div><p> 
 </p>
<p>ワーカーノード上での作業は以上です。</p>
<p> 
 </p>
<h3 id="kubernetesクラスターの状態確認">Kubernetesクラスターの状態確認</h3>
<p>Kubernetesクラスターの状態を確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME          STATUS   ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-worker1   Ready    &lt;none&gt;   24m     v1.20.4   172.29.156.14   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker2   Ready    &lt;none&gt;   6m16s   v1.20.4   172.29.156.15   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker3   Ready    &lt;none&gt;   4m21s   v1.20.4   172.29.156.16   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker4   Ready    &lt;none&gt;   2m49s   v1.20.4   172.29.156.17   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker5   Ready    &lt;none&gt;   2m52s   v1.20.4   172.29.156.18   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
</code></pre></div><p> </p>
<p>マスターノードに対してもワーカーノードとして動作できるように設定を行った場合のKubernetesクラスターの状態は以下のようになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME          STATUS   ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-master1   Ready    &lt;none&gt;   3m9s    v1.20.4   172.29.156.11   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-master2   Ready    &lt;none&gt;   108s    v1.20.4   172.29.156.12   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-master3   Ready    &lt;none&gt;   22s     v1.20.4   172.29.156.13   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker1   Ready    &lt;none&gt;   27m     v1.20.4   172.29.156.14   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker2   Ready    &lt;none&gt;   9m50s   v1.20.4   172.29.156.15   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker3   Ready    &lt;none&gt;   7m55s   v1.20.4   172.29.156.16   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker4   Ready    &lt;none&gt;   6m23s   v1.20.4   172.29.156.17   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker5   Ready    &lt;none&gt;   6m26s   v1.20.4   172.29.156.18   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
</code></pre></div><p> </p>
<p>下記のようなコマンドを実行し、マスターノードに対しては基本的にPodが作成されないようにroleとtaintを追加します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl label node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/master<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
kubectl label node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/controlplane<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
kubectl label node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/etcd<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
kubectl taint node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/master<span style="color:#f92672">=</span>:NoSchedule
kubectl taint node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/controlplane<span style="color:#f92672">=</span>:NoSchedule
kubectl taint node <span style="color:#e6db74">`</span>hostname<span style="color:#e6db74">`</span> node-role.kubernetes.io/etcd<span style="color:#f92672">=</span>:NoSchedule
</code></pre></div><p> </p>
<p>上記のコマンド実行後のKubernetesクラスターの状態は以下のようになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME          STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-master1   Ready    control-plane,master   9m11s   v1.20.4   172.29.156.11   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-master2   Ready    control-plane,master   7m50s   v1.20.4   172.29.156.12   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-master3   Ready    control-plane,master   6m24s   v1.20.4   172.29.156.13   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker1   Ready    &lt;none&gt;                 34m     v1.20.4   172.29.156.14   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker2   Ready    &lt;none&gt;                 15m     v1.20.4   172.29.156.15   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker3   Ready    &lt;none&gt;                 13m     v1.20.4   172.29.156.16   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker4   Ready    &lt;none&gt;                 12m     v1.20.4   172.29.156.17   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
k8s-worker5   Ready    &lt;none&gt;                 12m     v1.20.4   172.29.156.18   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-1032-raspi   containerd://1.3.3-0ubuntu2.3
</code></pre></div><p> </p>
<h3 id="corednsのデプロイ">CoreDNSのデプロイ</h3>
<p>Kubernetesクラスター内部の名前解決を行うためにCoreDNSをデプロイします。</p>
<p>下記の内容のマニフェストファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:coredns.yaml" data-lang=":coredns.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/bootstrapping</span>: <span style="color:#ae81ff">rbac-defaults</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">apiGroups</span>:
    - <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#ae81ff">endpoints</span>
    - <span style="color:#ae81ff">services</span>
    - <span style="color:#ae81ff">pods</span>
    - <span style="color:#ae81ff">namespaces</span>
    <span style="color:#f92672">verbs</span>:
    - <span style="color:#ae81ff">list</span>
    - <span style="color:#ae81ff">watch</span>
  - <span style="color:#f92672">apiGroups</span>:
    - <span style="color:#ae81ff">discovery.k8s.io</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#ae81ff">endpointslices</span>
    <span style="color:#f92672">verbs</span>:
    - <span style="color:#ae81ff">list</span>
    - <span style="color:#ae81ff">watch</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">rbac.authorization.kubernetes.io/autoupdate</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/bootstrapping</span>: <span style="color:#ae81ff">rbac-defaults</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">Corefile</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    .:53 {
</span><span style="color:#e6db74">        log
</span><span style="color:#e6db74">        errors
</span><span style="color:#e6db74">        health {
</span><span style="color:#e6db74">          lameduck 5s
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">        ready
</span><span style="color:#e6db74">        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span><span style="color:#e6db74">          fallthrough in-addr.arpa ip6.arpa
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">        prometheus :9153
</span><span style="color:#e6db74">        forward . /etc/resolv.conf {
</span><span style="color:#e6db74">          max_concurrent 1000
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">        cache 30
</span><span style="color:#e6db74">        loop
</span><span style="color:#e6db74">        reload
</span><span style="color:#e6db74">        loadbalance
</span><span style="color:#e6db74">    }</span>    
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kube-dns</span>
    <span style="color:#f92672">kubernetes.io/name</span>: <span style="color:#e6db74">&#34;CoreDNS&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kube-dns</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kube-dns</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">priorityClassName</span>: <span style="color:#ae81ff">system-cluster-critical</span>
      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">coredns</span>
      <span style="color:#f92672">tolerations</span>:
        - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;CriticalAddonsOnly&#34;</span>
          <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Exists&#34;</span>
      <span style="color:#f92672">nodeSelector</span>:
        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">linux</span>
      <span style="color:#f92672">affinity</span>:
         <span style="color:#f92672">podAntiAffinity</span>:
           <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:
           - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
             <span style="color:#f92672">podAffinityTerm</span>:
               <span style="color:#f92672">labelSelector</span>:
                 <span style="color:#f92672">matchExpressions</span>:
                   - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">k8s-app</span>
                     <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
                     <span style="color:#f92672">values</span>: [<span style="color:#e6db74">&#34;kube-dns&#34;</span>]
               <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">coredns/coredns:1.8.3</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
        <span style="color:#f92672">resources</span>:
          <span style="color:#f92672">limits</span>:
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">170Mi</span>
          <span style="color:#f92672">requests</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">70Mi</span>
        <span style="color:#f92672">args</span>: [ <span style="color:#e6db74">&#34;-conf&#34;</span>, <span style="color:#e6db74">&#34;/etc/coredns/Corefile&#34;</span> ]
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/coredns</span>
          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">53</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">UDP</span>
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">53</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns-tcp</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9153</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
        <span style="color:#f92672">securityContext</span>:
          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
          <span style="color:#f92672">capabilities</span>:
            <span style="color:#f92672">add</span>:
            - <span style="color:#ae81ff">NET_BIND_SERVICE</span>
            <span style="color:#f92672">drop</span>:
            - <span style="color:#ae81ff">all</span>
          <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">livenessProbe</span>:
          <span style="color:#f92672">httpGet</span>:
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/health</span>
            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#f92672">readinessProbe</span>:
          <span style="color:#f92672">httpGet</span>:
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/ready</span>
            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8181</span>
            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
      <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">Default</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
            <span style="color:#f92672">items</span>:
            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">Corefile</span>
              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">Corefile</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-dns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#34;9153&#34;</span>
    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kube-dns</span>
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/name</span>: <span style="color:#e6db74">&#34;CoreDNS&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kube-dns</span>
  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.96.0.10</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">53</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">UDP</span>
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns-tcp</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">53</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9153</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</code></pre></div><p> </p>
<p>CoreDNSをデプロイします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f coredns.yaml 
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre></div><p> </p>
<p>リソースが作成されたことを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl -n kube-system get all
NAME                           READY   STATUS    RESTARTS   AGE
pod/coredns-867bfd96bd-9g87v   1/1     Running   <span style="color:#ae81ff">0</span>          49s
pod/coredns-867bfd96bd-9tbz7   1/1     Running   <span style="color:#ae81ff">0</span>          49s

NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                  AGE
service/kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   49s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/coredns   2/2     <span style="color:#ae81ff">2</span>            <span style="color:#ae81ff">2</span>           49s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/coredns-867bfd96bd   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       49s
</code></pre></div><p> </p>
<p>名前解決の機能がちゃんと動作しているか確認します。</p>
<p>下記の内容のマニフェストファイルを作成し、リソースを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dnsutils.yaml" data-lang="dnsutils.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dnsutils</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dnsutils</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/kubernetes-e2e-test-images/dnsutils:1.3</span>
    <span style="color:#f92672">command</span>:
      - <span style="color:#ae81ff">sleep</span>
      - <span style="color:#e6db74">&#34;3600&#34;</span>
    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span>
</code></pre></div><p> </p>
<p>リソースが作成されたことを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f dnsutils.yaml
pod/dnsutils created

$kubectl get all
NAME           READY   STATUS    RESTARTS   AGE
pod/dnsutils   1/1     Running   <span style="color:#ae81ff">0</span>          24s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE
service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   14h
</code></pre></div><p> </p>
<p>名前解決が行えることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -i -t dnsutils -- nslookup kubernetes.default
Server:		10.96.0.10
Address:	10.96.0.10#53

Name:	kubernetes.default.svc.cluster.local
Address: 10.96.0.1

</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -i -t dnsutils -- nslookup google.com
Server:		10.96.0.10
Address:	10.96.0.10#53

Non-authoritative answer:
Name:	google.com
Address: 172.217.175.110
Name:	google.com
Address: 2404:6800:4004:80e::200e
</code></pre></div><p>確認後、リソースを削除します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl delete -f dnsutils.yaml
pod <span style="color:#e6db74">&#34;dnsutils&#34;</span> deleted
</code></pre></div><p> </p>
<h3 id="kubernetesクラスターの最終動作確認">Kubernetesクラスターの最終動作確認</h3>
<p>最後にKubernetesクラスターがちゃんと動作しているか確認を行います。</p>
<p>Secret が暗号化されて保存されていることを確認します。</p>
<p>本来は base64 encoded な値が表示されますが、そうでない暗号化されたデータが見えれば OK です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create secret generic kubernetes-the-hard-way <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;   --from-literal<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mykey=mydata&#34;</span>
secret/kubernetes-the-hard-way created

$ etcdctl get <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;     --endpoints<span style="color:#f92672">=</span>https://127.0.0.1:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;     --cacert /etc/etcd/etcd-ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;     --cert /etc/etcd/kube-etcd-healthcheck-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;     --key /etc/etcd/kube-etcd-healthcheck-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>&gt;     /registry/secrets/default/kubernetes-the-hard-way | hexdump -C
<span style="color:#ae81ff">00000000</span>  2f <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">72</span>  <span style="color:#ae81ff">79</span> 2f <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">74</span>  |/registry/secret|
<span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">73</span> 2f <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">75</span> 6c  <span style="color:#ae81ff">74</span> 2f 6b <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">72</span> 6e  |s/default/kubern|
<span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span> 2d <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">65</span>  2d <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">64</span> 2d <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">61</span>  |etes-the-hard-wa|
<span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">79</span> 0a 6b <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">73</span> 3a <span style="color:#ae81ff">65</span> 6e  <span style="color:#ae81ff">63</span> 3a <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">63</span>  |y.k8s:enc:aescbc|
<span style="color:#ae81ff">00000040</span>  3a <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">31</span> 3a 6b <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">31</span>  3a <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">69</span> f4 <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">80</span> eb  |:v1:key1:3ii....|
<span style="color:#ae81ff">00000050</span>  3a <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">18</span> fe <span style="color:#ae81ff">30</span> 2f ef  <span style="color:#ae81ff">25</span> da f2 e7 6c <span style="color:#ae81ff">03</span> 4b 2c  |:.<span style="color:#f92672">(</span>..0/.%...l.K,|
<span style="color:#ae81ff">00000060</span>  <span style="color:#ae81ff">49</span> f3 8f 5d ca 4b 6e <span style="color:#ae81ff">70</span>  <span style="color:#ae81ff">31</span> 5a dd <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">28</span> f0 8c e8  |I..<span style="color:#f92672">]</span>.Knp1Z..<span style="color:#f92672">(</span>...|
<span style="color:#ae81ff">00000070</span>  1e 3f <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">07</span> 0a f6 fb cd  5b <span style="color:#ae81ff">08</span> 5b <span style="color:#ae81ff">41</span> e4 da 0a <span style="color:#ae81ff">25</span>  |.?D.....<span style="color:#f92672">[</span>.<span style="color:#f92672">[</span>A...%|
<span style="color:#ae81ff">00000080</span>  d1 2d <span style="color:#ae81ff">46</span> fb ab <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">49</span>  3a b2 e1 <span style="color:#ae81ff">39</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">93</span> 3b e3  |.-F...@I:..9e.;.|
<span style="color:#ae81ff">00000090</span>  8b <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">53</span> 4e <span style="color:#ae81ff">97</span> c7 aa  0f <span style="color:#ae81ff">98</span> 2f ab b7 <span style="color:#ae81ff">49</span> 6c cc  |..%SN...../..Il.|
000000a0  d5 <span style="color:#ae81ff">98</span> 5a 9b 9c d4 <span style="color:#ae81ff">22</span> 6e  <span style="color:#ae81ff">50</span> b4 <span style="color:#ae81ff">20</span> 5c a5 7d <span style="color:#ae81ff">63</span> 5c  |..Z...<span style="color:#e6db74">&#34;nP. \.}c\|
</span><span style="color:#e6db74">000000b0  ec b6 98 fb f0 1d 07 ba  16 91 61 fe ab 84 99 ae  |..........a.....|
</span><span style="color:#e6db74">000000c0  ff 4f 53 f8 15 75 c8 67  9d d1 de 5d 4a d4 ab 73  |.OS..u.g...]J..s|
</span><span style="color:#e6db74">000000d0  0c 1f 62 df ad bd 86 b3  10 55 fb 32 39 3d 7b ae  |..b......U.29={.|
</span><span style="color:#e6db74">000000e0  5c 3d 59 10 85 de 57 c9  c9 6e b9 e1 12 59 be f9  |\=Y...W..n...Y..|
</span><span style="color:#e6db74">000000f0  47 a9 82 d2 fb 07 ee f5  3a 3d 88 15 dd f6 4d 0f  |G.......:=....M.|
</span><span style="color:#e6db74">00000100  44 1c 68 36 7e ff 44 b9  b7 e9 2b b8 96 e9 40 9d  |D.h6~.D...+...@.|
</span><span style="color:#e6db74">00000110  f7 bc a0 e9 f9 a2 f4 07  f8 59 e7 9c f5 65 4f 91  |.........Y...eO.|
</span><span style="color:#e6db74">00000120  74 e6 65 57 9f c7 3a 1d  26 0a 58 26 70 2e 51 33  |t.eW..:.&amp;.X&amp;p.Q3|
</span><span style="color:#e6db74">00000130  9b 7e 40 3a 2e e2 32 92  9f f2 c1 8e 15 fa da 0a  |.~@:..2.........|
</span><span style="color:#e6db74">00000140  c3 f0 c6 7a cb 49 65 74  1b 47 8e 0e 63 17 b9 23  |...z.Iet.G..c..#|
</span><span style="color:#e6db74">00000150  ab 8a a6 bf 35 67 4e ab  e4 0a                    |....5gN...|
</span><span style="color:#e6db74">0000015a
</span></code></pre></div><p> </p>
<p>作成したリソースを削除します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl delete secrets/kubernetes-the-hard-way
secret <span style="color:#e6db74">&#34;kubernetes-the-hard-way&#34;</span> deleted
</code></pre></div><p> </p>
<p>Podが起動できることを確認します。</p>
<p>nginxをデプロイするために、下記の内容のマニフェストファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:nginx.yaml" data-lang=":nginx.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.15</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p> </p>
<p>nginxをデプロイします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f nginx.yaml
deployment.apps/nginx created
</code></pre></div><p> </p>
<p>Port Forwardingが機能することを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ POD_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pods -l app<span style="color:#f92672">=</span>nginx -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span>
$ kubectl port-forward $POD_NAME 8081:80
Forwarding from 127.0.0.1:8081 -&gt; <span style="color:#ae81ff">80</span>
Forwarding from <span style="color:#f92672">[</span>::1<span style="color:#f92672">]</span>:8081 -&gt; <span style="color:#ae81ff">80</span>

$ curl --head http://127.0.0.1:8081
HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Server: nginx/1.15.12
Date: Tue, <span style="color:#ae81ff">30</span> Mar <span style="color:#ae81ff">2021</span> 03:51:42 GMT
Content-Type: text/html
Content-Length: <span style="color:#ae81ff">612</span>
Last-Modified: Tue, <span style="color:#ae81ff">16</span> Apr <span style="color:#ae81ff">2019</span> 13:08:19 GMT
Connection: keep-alive
ETag: <span style="color:#e6db74">&#34;5cb5d3c3-264&#34;</span>
Accept-Ranges: bytes

</code></pre></div><p> </p>
<p>Pod のログにアクセスできることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl logs $POD_NAME
127.0.0.1 - - <span style="color:#f92672">[</span>30/Mar/2021:03:51:42 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;HEAD / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/7.68.0&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</code></pre></div><p> </p>
<p>Pod 上でコマンドを実行できることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -ti $POD_NAME -- nginx -v
nginx version: nginx/1.15.12
</code></pre></div><p> </p>
<p>NodePort を通じてアクセスできることを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl expose deployment nginx --port <span style="color:#ae81ff">80</span> --type NodePort
service/nginx exposed

$ kubectl get svc
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        15h
nginx        NodePort    10.111.137.3   &lt;none&gt;        80:32577/TCP   5s

curl -I http://10.111.137.3
HTTP/1.1 <span style="color:#ae81ff">200</span> OK
Server: nginx/1.15.12
Date: Tue, <span style="color:#ae81ff">30</span> Mar <span style="color:#ae81ff">2021</span> 03:54:15 GMT
Content-Type: text/html
Content-Length: <span style="color:#ae81ff">612</span>
Last-Modified: Tue, <span style="color:#ae81ff">16</span> Apr <span style="color:#ae81ff">2019</span> 13:08:19 GMT
Connection: keep-alive
ETag: <span style="color:#e6db74">&#34;5cb5d3c3-264&#34;</span>
Accept-Ranges: bytes

</code></pre></div><p> </p>
<p>最終動作確認後、作成したリソースを削除します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl delete svc/nginx
service <span style="color:#e6db74">&#34;nginx&#34;</span> deleted

$ kubectl delete -f nginx.yaml 
deployment.apps <span style="color:#e6db74">&#34;nginx&#34;</span> deleted
</code></pre></div><p> </p>
<h3 id="最後に">最後に</h3>
<p>以上でKubernetes The Hard Way on Raspberry Piは終了です。</p>
<p>本記事が少しでも皆様のお役に立てれば幸いです。</p>
<p> </p>
<h3 id="copyright">Copyright</h3>
<p>本手順は株式会社サイバーエージェント様の<a href="https://github.com/CyberAgentHack/home-kubernetes-2020/tree/master/how-to-create-cluster-logical-hardway">CyberAgentHack/home-kubernetes-2020/how-to-create-cluster-logical-hardway</a>をもとに学習用に書いたものであり、<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>の下に公開されています。</p>
<p> </p>
</div>
    <div class="post-footer">
      <div class="info">
        

        
      </div>
    </div>

    
  </div>

  <div>
    
      <div id="commpost"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://commpost.sosomasox.com/js/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

         var dlq = document.createElement('link');
         dlq.rel = 'stylesheet'; dlq.type = 'text/css'; dlq.href = 'https://commpost.sosomasox.com/assets/css/embed.css';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dlq);
    })();
</script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          sosomasox
          2022


        
      </li>
      
        <li class="footer__item">
          <a
            href="/imprint/"
            
            title=""
          >
            imprint
          </a>
        </li>

      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR&#43;zwDAROtph0PXGte6ia8heboACF9R5l/DiY&#43;WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous" /><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8&#43;w2LAIftJEULZABrF9PPFv&#43;tVkH" crossorigin="anonymous"></script><script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js"
      integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB&#43;w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v"
      crossorigin="anonymous"
      onload="renderMathInElement(document.body);"
    ></script></body>
</html>
